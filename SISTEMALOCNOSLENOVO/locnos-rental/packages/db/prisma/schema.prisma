// Prisma schema for Locnos rental management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multiunit (branches/warehouses)
model Unit {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  address   String?
  city      String?
  state     String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  items     EquipmentItem[]
}

// Users and RBAC
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role
  unitId    String?
  unit      Unit?    @relation(fields: [unitId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  MANAGER
  SALES
  FIELD
  FINANCE
}

// Customers and Suppliers
model Customer {
  id          String   @id @default(cuid())
  name        String
  documentId  String? // CPF/CNPJ
  email       String?
  phone       String?
  address     String?
  asaasCustomerId String? @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contracts   Contract[]
  reservations Reservation[]
}

model Supplier {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Equipment catalog vs physical items (serialized)
model Category {
  id        String   @id @default(cuid())
  name      String
  parentId  String?
  parent    Category? @relation("CategoryToCategory", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryToCategory")
}

model EquipmentModel {
  id           String   @id @default(cuid())
  name         String
  description  String?
  dailyRate    Decimal  @db.Decimal(10,2)
  weeklyRate   Decimal? @db.Decimal(10,2)
  monthlyRate  Decimal? @db.Decimal(10,2)
  barcodeSku   String?  @unique
  categoryId   String?
  category     Category? @relation(fields: [categoryId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  items        EquipmentItem[]
}

model EquipmentItem {
  id            String   @id @default(cuid())
  serialNumber  String?  @unique
  qrCode        String?  @unique
  status        ItemStatus @default(AVAILABLE)
  unitId        String
  unit          Unit      @relation(fields: [unitId], references: [id])
  modelId       String
  model         EquipmentModel @relation(fields: [modelId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  inventoryMovs InventoryMovement[]
  reservationItems ReservationItem[]
  contractItems ContractItem[]
  maintenances  Maintenance[]

  @@index([unitId])
  @@index([status])
}

enum ItemStatus {
  AVAILABLE
  RESERVED
  RENTED
  MAINTENANCE
  INACTIVE
}

// Reservations and Contracts
model Reservation {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])
  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id])
  startDate   DateTime
  endDate     DateTime
  status      ReservationStatus @default(PENDING)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  items       ReservationItem[]
  quoteTotal  Decimal  @default(0.0) @db.Decimal(12,2)
}

enum ReservationStatus {
  PENDING
  APPROVED
  CONVERTED
  CANCELLED
}

model ReservationItem {
  id           String   @id @default(cuid())
  reservationId String
  reservation   Reservation @relation(fields: [reservationId], references: [id])
  itemId       String
  item         EquipmentItem @relation(fields: [itemId], references: [id])
  rateType     RateType
  rateValue    Decimal @db.Decimal(10,2)
  discount     Decimal? @db.Decimal(10,2)

  @@index([itemId])
  @@index([reservationId])
}

enum RateType {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

model Contract {
  id            String   @id @default(cuid())
  reservationId String?
  reservation   Reservation? @relation(fields: [reservationId], references: [id])
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  unitId        String
  unit          Unit     @relation(fields: [unitId], references: [id])
  startDate     DateTime
  endDate       DateTime?
  status        ContractStatus @default(ACTIVE)
  totalValue    Decimal @default(0.0) @db.Decimal(12,2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  items         ContractItem[]
  invoices      Invoice[]
  deliveries    DeliverySchedule[]
}

enum ContractStatus {
  ACTIVE
  CLOSED
  CANCELLED
  LATE
}

model ContractItem {
  id         String   @id @default(cuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])
  itemId     String
  item       EquipmentItem @relation(fields: [itemId], references: [id])
  rateType   RateType
  rateValue  Decimal @db.Decimal(10,2)
  discount   Decimal? @db.Decimal(10,2)
  returnedAt DateTime?

  @@index([itemId])
  @@index([contractId])
}

// Inventory movements for auditing
model InventoryMovement {
  id        String   @id @default(cuid())
  itemId    String
  item      EquipmentItem @relation(fields: [itemId], references: [id])
  type      InventoryMovementType
  quantity  Int      @default(1)
  reason    String?
  createdAt DateTime @default(now())
}

enum InventoryMovementType {
  RENT_OUT
  RETURN
  TRANSFER_OUT
  TRANSFER_IN
  MAINTENANCE_OUT
  MAINTENANCE_IN
}

// Maintenance
model Maintenance {
  id         String   @id @default(cuid())
  itemId     String
  item       EquipmentItem @relation(fields: [itemId], references: [id])
  type       MaintenanceType
  description String?
  cost       Decimal? @db.Decimal(10,2)
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
}

// Logistics
model DeliverySchedule {
  id          String   @id @default(cuid())
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id])
  type        DeliveryType
  scheduledAt DateTime
  address     String
  city        String?
  status      DeliveryStatus @default(SCHEDULED)
  notes       String?
}

enum DeliveryType {
  DELIVERY
  PICKUP
}

enum DeliveryStatus {
  SCHEDULED
  IN_TRANSIT
  COMPLETED
  FAILED
}

// Finance (simplified)
model Invoice {
  id          String   @id @default(cuid())
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id])
  dueDate     DateTime
  issueDate   DateTime @default(now())
  amount      Decimal  @db.Decimal(12,2)
  status      InvoiceStatus @default(OPEN)
  boletoUrl   String? // placeholder for boleto integration
  nfseNumber  String? // placeholder for NFS-e integration
  asaasPaymentId String?
  payments    Payment[]
}

enum InvoiceStatus {
  OPEN
  PAID
  CANCELLED
  OVERDUE
}

model Payment {
  id         String   @id @default(cuid())
  invoiceId  String
  invoice    Invoice @relation(fields: [invoiceId], references: [id])
  paidAt     DateTime
  amount     Decimal @db.Decimal(12,2)
  method     PaymentMethod
  reference  String?
}

enum PaymentMethod {
  BOLETO
  PIX
  CREDIT_CARD
  CASH
  TRANSFER
}
