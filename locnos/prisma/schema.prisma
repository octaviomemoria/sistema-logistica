generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("USER") // ADMIN, DRIVER, MANAGER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  deliveries Rental[] @relation("DeliveryDriver")
  returns    Rental[] @relation("ReturnDriver")
  routes     Route[]  @relation("DriverRoutes")
}


model PersonType {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String   @default("#3B82F6")
  system    Boolean  @default(false) // System types cannot be deleted
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  persons   PersonPersonType[]
}

model Person {
  id          String   @id @default(cuid())
  type        String   @default("PF") // PF or PJ
  name        String
  tradeName   String?
  document    String   @unique // CPF or CNPJ
  
  // Contact
  email       String?
  phone       String
  
  // Address
  zipCode     String
  street      String
  number      String
  complement  String?
  neighborhood String
  city        String
  state       String
  
  // Business Rules
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, DEFAULTER
  active      Boolean  @default(true)
  
  // Extra Data
  documents   String[] // Array of base64 strings or URLs
  references  Json?    // Stores array of objects
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  personTypes PersonPersonType[]
  rentals     Rental[]
}

model PersonPersonType {
  personId     String
  person       Person     @relation(fields: [personId], references: [id], onDelete: Cascade)
  
  personTypeId String
  personType   PersonType @relation(fields: [personTypeId], references: [id], onDelete: Cascade)
  
  assignedAt   DateTime   @default(now())
  
  @@id([personId, personTypeId])
}


model Equipment {
  id              String   @id @default(cuid())
  name            String
  category        String
  subCategory     String?
  brand           String?
  description     String?
  
  // Financial
  purchasePrice   Float    @default(0)
  salePrice       Float?
  replacementValue Float?  @default(0) // Value for damage/loss
  suggestedDeposit Float?
  
  // Stock
  totalQty        Int      @default(1)
  rentedQty       Int      @default(0)
  
  // Media (Base64 or URL)
  imageUrl        String?
  
  // Dynamic JSON Fields
  // rentalPeriods: Array of { description: string, days: number, price: float }
  rentalPeriods   Json?
  // specifications: Array of { key: string, value: string }
  specifications  Json?
  // externalLinks: Array of strings
  externalLinks   String[]
  
  // Relations
  rentalItems     RentalItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  maintenances    Maintenance[]
}

model Maintenance {
  id          String    @id @default(cuid())
  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  
  type        String    @default("CORRECTIVE") // PREVENTIVE, CORRECTIVE
  description String?
  cost        Float     @default(0)
  
  startDate   DateTime  @default(now())
  endDate     DateTime?
  
  status      String    @default("OPEN") // OPEN, COMPLETED
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// --- NEW MODULES ---

model ContractTemplate {
  id          String   @id @default(cuid())
  name        String
  content     String   // The text with {{Placeholders}}
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Enums
enum RentalStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
  LATE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

enum RentalType {
  DAILY
  MONTHLY
}

model Rental {
  id              String   @id @default(cuid())
  
  // Relations
  personId        String
  person          Person @relation(fields: [personId], references: [id])
  
  deliveryDriverId String?
  deliveryDriver   User?   @relation("DeliveryDriver", fields: [deliveryDriverId], references: [id])
  
  returnDriverId   String?
  returnDriver     User?   @relation("ReturnDriver", fields: [returnDriverId], references: [id])

  // Dates
  startDate       DateTime
  endDate         DateTime
  durationDays    Int      @default(1)
  
  // Type & Status
  type            RentalType     @default(DAILY)
  status          RentalStatus   @default(DRAFT)
  paymentStatus   PaymentStatus  @default(PENDING)
  
  // Financials
  totalAmount     Float    @default(0)
  amountPaid      Float    @default(0)  // Calculated field: sum of all payments
  paymentMethod   String?  // Deprecated: kept for backward compatibility
  totalItems      Float    @default(0) // Sum of items
  discount        Float    @default(0)
  deliveryFee     Float    @default(0)
  returnFee       Float    @default(0)
  securityDeposit Float    @default(0)
  
  // Logistics
  usageAddress    Json?    // Detailed address structure
  deliveryAddress String?  // Quick reference string
  observations    String?
  
  // Cancellation
  cancellationReason String?   // Reason for cancellation
  cancelledAt        DateTime? // When it was cancelled
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           RentalItem[]
  occurrences     RentalOccurrence[]
  payments        Payment[]
  routeStops      RouteStop[]
}


model RentalItem {
  id          String    @id @default(cuid())
  rentalId    String
  rental      Rental    @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  
  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  
  // Snapshot Data
  unitPrice   Float
  quantity    Int
  totalPrice  Float
  depositValue Float    @default(0)
}

model RentalOccurrence {
  id          String   @id @default(cuid())
  rentalId    String
  rental      Rental   @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  type        String   @default("OTHER") // DAMAGE, LOSS, CLEANING, OTHER
  cost        Float    @default(0)
  
  resolved    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payment {
  id            String   @id @default(cuid())
  rentalId      String
  rental        Rental   @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  
  amount        Float
  paymentMethod String
  paymentDate   DateTime
  
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Route {
  id        String   @id @default(cuid())
  date      DateTime @default(now())
  
  driverId  String
  driver    User     @relation("DriverRoutes", fields: [driverId], references: [id])
  
  status    String   @default("DRAFT") // DRAFT, CONFIRMED, IN_PROGRESS, COMPLETED
  
  stops     RouteStop[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RouteStop {
  id          String   @id @default(cuid())
  
  routeId     String
  route       Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  
  rentalId    String
  rental      Rental   @relation(fields: [rentalId], references: [id])
  
  type        String   // DELIVERY, RETURN
  sequence    Int
  
  status      String   @default("PENDING") // PENDING, SKIPPED, COMPLETED
  completedAt DateTime?
  
  // Proof of Delivery
  signature   String?  // Base64 string
  receiverName String?
  photos      String[]
  geoLat      Float?
  geoLng      Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

